name: PR Preview

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    contents: read
    pull-requests: write
    deployments: write

jobs:
    preview:
        runs-on: ubuntu-latest
        name: Deploy PR Preview

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run type checking
              run: bun run type-check

            # - name: Deploy preview with Wrangler
            #   id: deploy
            #   run: |
            #       VERSION_OUTPUT=$(bun wrangler versions upload)
            #       echo "Wrangler output:"
            #       echo "$VERSION_OUTPUT"

            #       # Extract version ID from the "Worker Version ID:" line
            #       VERSION_ID=$(echo "$VERSION_OUTPUT" | grep "Worker Version ID:" | sed 's/Worker Version ID: //')
            #       echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT

            #       # Extract preview URL from the "Version Preview URL:" line
            #       PREVIEW_URL=$(echo "$VERSION_OUTPUT" | grep "Version Preview URL:" | sed 's/Version Preview URL: //')
            #       echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

            #       echo "Extracted Version ID: $VERSION_ID"
            #       echo "Extracted Preview URL: $PREVIEW_URL"
            #   env:
            #       CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            #       CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            # - name: Update PR with preview URL
            #   uses: actions/github-script@v7
            #   with:
            #       script: |
            #           const versionId = '${{ steps.deploy.outputs.version_id }}';
            #           const previewUrl = '${{ steps.deploy.outputs.preview_url }}';

            #           const { data: comments } = await github.rest.issues.listComments({
            #             owner: context.repo.owner,
            #             repo: context.repo.repo,
            #             issue_number: context.issue.number,
            #           });

            #           const botComment = comments.find(comment => 
            #             comment.user.type === 'Bot' && 
            #             comment.body.includes('ðŸš€ PR Preview Deployed')
            #           );

            #           const commentBody = `
            #           ðŸš€ **PR Preview Deployed**

            #           Your changes have been deployed to a preview environment:

            #           **ðŸ”— Preview URL:** ${previewUrl}
            #           **ðŸ“¦ Version ID:** \`${versionId}\`
            #           **ðŸ”„ Updated:** ${new Date().toUTCString()}

            #           The preview will be available for testing and will update automatically with new commits to this PR.
            #           `;

            #           if (botComment) {
            #             await github.rest.issues.updateComment({
            #               owner: context.repo.owner,
            #               repo: context.repo.repo,
            #               comment_id: botComment.id,
            #               body: commentBody
            #             });
            #           } else {
            #             await github.rest.issues.createComment({
            #               owner: context.repo.owner,
            #               repo: context.repo.repo,
            #               issue_number: context.issue.number,
            #               body: commentBody
            #             });
            #           }

            # - name: Create deployment status
            #   uses: chrnorm/deployment-action@v2
            #   with:
            #       token: "${{ github.token }}"
            #       environment-url: ${{ steps.deploy.outputs.preview_url }}
            #       environment: preview
